#!/usr/bin/env python3

"""External drive backup."""

import sys
import os
import subprocess
import time
import atexit

try:
    from scriptbase import cli
except ImportError:
    sys.path.insert(0, os.path.join(
        os.path.dirname(os.path.dirname(__file__)), 'ext', 'scriptbase'))
    from scriptbase import cli
from scriptbase import console  #pylint: disable=import-error
from scriptbase import disk     #pylint: disable=import-error


class Constants:
    """Constant data."""
    output_name_format = '{name}-{timestamp}.img.gz'
    app_description = 'Mac volume image reader/writer'


class Cleanup:
    """Data used for cleanup."""
    files_to_delete = []


def generate_volume_output_path(volume_name, output_dir):
    """Generate an output path for a volume backup file."""
    return os.path.join(output_dir, Constants.output_name_format.format(
        name=volume_name,
        timestamp=time.strftime('%Y-%m-%d-%H%M%S')))


def at_exit():
    """Delete partial files, etc.."""
    for file_to_delete in Cleanup.files_to_delete:
        if os.path.exists(file_to_delete):
            try:
                console.info('Removing partial file: {}'.format(file_to_delete))
                os.remove(file_to_delete)
            except (IOError, OSError) as exc:
                console.error(exc)


@cli.Main(Constants.app_description)
def main(_runner):
    """Called by cli module at startup."""
    atexit.register(at_exit)


@cli.Command(
    name='save',
    description='make a volume image',
    args=[
        cli.String('INPUT_VOLUME', 'volume name, device, UUID, or mountpoint', nargs=1),
        cli.String('OUTPUT_DIR', 'output directory for backup image', nargs=1),
    ]
)
def cli_save(runner):
    """Back up input device."""
    volume = disk.volume_for_identifier(runner.arg.INPUT_VOLUME[0])
    if volume.mountpoint:
        console.info('Unmounting: {}'.format(volume.mountpoint))
        disk.volume_unmount(volume)
    output_path = generate_volume_output_path(volume.name, runner.arg.OUTPUT_DIR[0])
    console.info('Input device: {}'.format(volume.raw_disk_dev))
    console.info(' Output path: {}'.format(output_path))
    console.info('-----')
    Cleanup.files_to_delete.append(output_path)
    disk.gzip_device(volume.raw_disk_dev, output_path)
    Cleanup.files_to_delete.pop()


if __name__ == '__main__':
    try:
        cli.main()
    except KeyboardInterrupt:
        console.info('')
        console.info('<break>')
        sys.exit(2)
    except subprocess.CalledProcessError as exc:
        console.abort(str(exc))
    except (IOError, OSError) as exc:
        console.abort(str(exc))
